name: Build Android Auto App (Gradle 9.3)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Gradle 9系は Java 17以上が必須（21推奨ですが17でも動きます）
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # ★変更点：手動でのGradleインストールは削除しました。
      # システム標準の Gradle 9.3 をそのまま使います。

      - name: Generate Project Files (Latest Versions)
        shell: bash
        run: |
          set -euxo pipefail

          PKG="com.example.drivesense"
          APP_LABEL="Drive Sense"

          # --- 1. settings.gradle.kts ---
          cat > settings.gradle.kts <<EOF
          pluginManagement {
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
          }
          dependencyResolutionManagement {
              repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
              repositories {
                  google()
                  mavenCentral()
              }
          }
          rootProject.name = "DriveSense"
          include(":app")
          EOF

          # --- 2. ルート build.gradle.kts ---
          # ★ここが重要：Gradle 9.3 に対応するため、最新のプラグインを指定します
          # AGP 8.7.0 / Kotlin 2.0.21
          cat > build.gradle.kts <<EOF
          plugins {
              id("com.android.application") version "8.7.0" apply false
              id("org.jetbrains.kotlin.android") version "2.0.21" apply false
          }
          EOF

          # --- 3. gradle.properties ---
          cat > gradle.properties <<EOF
          org.gradle.jvmargs=-Xmx3g -Dfile.encoding=UTF-8
          android.useAndroidX=true
          android.enableJetifier=true
          kotlin.code.style=official
          EOF

          # --- 4. アプリモジュール作成 ---
          mkdir -p app/src/main/{java/com/example/drivesense,res/xml,res/values,res/drawable,res/mipmap-anydpi-v26}

          cat > app/build.gradle.kts <<EOF
          plugins {
              id("com.android.application")
              id("org.jetbrains.kotlin.android")
          }

          android {
              namespace = "$PKG"
              compileSdk = 34

              defaultConfig {
                  applicationId = "$PKG"
                  minSdk = 23
                  targetSdk = 34
                  versionCode = 1
                  versionName = "1.0"
              }

              buildTypes {
                  release { isMinifyEnabled = false }
              }

              compileOptions {
                  sourceCompatibility = JavaVersion.VERSION_17
                  targetCompatibility = JavaVersion.VERSION_17
              }
              kotlinOptions { jvmTarget = "17" }
          }

          dependencies {
              implementation("androidx.core:core-ktx:1.13.1")
              implementation("androidx.appcompat:appcompat:1.7.0")
              implementation("androidx.media:media:1.7.0")
          }
          EOF

          # --- Resources & Code (変更なし) ---
          
          # strings.xml
          cat > app/src/main/res/values/strings.xml <<EOF
          <resources>
              <string name="app_name">$APP_LABEL</string>
          </resources>
          EOF

          # Android Auto XML
          cat > app/src/main/res/xml/automotive_app_desc.xml <<EOF
          <?xml version="1.0" encoding="utf-8"?>
          <automotiveApp xmlns:android="http://schemas.android.com/apk/res/android">
              <uses name="media" />
          </automotiveApp>
          EOF

          # Icons
          cat > app/src/main/res/drawable/ic_launcher_background.xml <<EOF
          <vector xmlns:android="http://schemas.android.com/apk/res/android"
              android:width="108dp" android:height="108dp"
              android:viewportWidth="108" android:viewportHeight="108">
              <path android:fillColor="#008577" android:pathData="M0,0h108v108h-108z"/>
          </vector>
          EOF

          cat > app/src/main/res/drawable/ic_launcher_foreground.xml <<EOF
          <vector xmlns:android="http://schemas.android.com/apk/res/android"
              android:width="108dp" android:height="108dp"
              android:viewportWidth="108" android:viewportHeight="108">
              <path android:fillColor="#FFFFFF" android:pathData="M54,26 A28,28 0 1,0 54,82 A28,28 0 1,0 54,26"/>
          </vector>
          EOF

          cat > app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml <<EOF
          <adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
              <background android:drawable="@drawable/ic_launcher_background"/>
              <foreground android:drawable="@drawable/ic_launcher_foreground"/>
          </adaptive-icon>
          EOF
          cp app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml app/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml

          # Manifest
          cat > app/src/main/AndroidManifest.xml <<EOF
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android"
              package="$PKG">

              <application
                  android:label="$APP_LABEL"
                  android:allowBackup="true"
                  android:supportsRtl="true"
                  android:icon="@mipmap/ic_launcher"
                  android:roundIcon="@mipmap/ic_launcher_round"
                  android:theme="@style/Theme.AppCompat.Light.NoActionBar">

                  <meta-data
                      android:name="com.google.android.gms.car.application"
                      android:resource="@xml/automotive_app_desc" />

                  <service
                      android:name=".DriveSenseMediaService"
                      android:exported="true">
                      <intent-filter>
                          <action android:name="android.media.browse.MediaBrowserService" />
                      </intent-filter>
                  </service>

                  <activity
                      android:name=".MainActivity"
                      android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>

              </application>
          </manifest>
          EOF

          # Kotlin Code
          cat > app/src/main/java/com/example/drivesense/MainActivity.kt <<EOF
          package $PKG
          import android.os.Bundle
          import androidx.appcompat.app.AppCompatActivity

          class MainActivity : AppCompatActivity() {
              override fun onCreate(savedInstanceState: Bundle?) {
                  super.onCreate(savedInstanceState)
              }
          }
          EOF

          cat > app/src/main/java/com/example/drivesense/DriveSenseMediaService.kt <<EOF
          package $PKG

          import android.os.Bundle
          import android.support.v4.media.MediaBrowserCompat
          import android.support.v4.media.MediaBrowserServiceCompat
          import android.support.v4.media.MediaMetadataCompat
          import android.support.v4.media.session.MediaSessionCompat
          import android.support.v4.media.session.PlaybackStateCompat

          class DriveSenseMediaService : MediaBrowserServiceCompat() {
              private lateinit var mediaSession: MediaSessionCompat

              override fun onCreate() {
                  super.onCreate()

                  mediaSession = MediaSessionCompat(this, "DriveSenseSession").apply {
                      setCallback(object : MediaSessionCompat.Callback() {})
                      isActive = true

                      val state = PlaybackStateCompat.Builder()
                          .setActions(PlaybackStateCompat.ACTION_PLAY or PlaybackStateCompat.ACTION_PAUSE)
                          .setState(PlaybackStateCompat.STATE_PLAYING, 0L, 1.0f)
                          .build()
                      setPlaybackState(state)

                      val metadata = MediaMetadataCompat.Builder()
                          .putString(MediaMetadataCompat.METADATA_KEY_TITLE, "Drive Sense Active")
                          .putString(MediaMetadataCompat.METADATA_KEY_DISPLAY_TITLE, "Drive Sense")
                          .putString(MediaMetadataCompat.METADATA_KEY_ARTIST, "System Ready")
                          .build()
                      setMetadata(metadata)
                  }

                  sessionToken = mediaSession.sessionToken
              }

              override fun onDestroy() {
                  mediaSession.isActive = false
                  mediaSession.release()
                  super.onDestroy()
              }

              override fun onGetRoot(
                  clientPackageName: String,
                  clientUid: Int,
                  rootHints: Bundle?
              ): BrowserRoot {
                  return BrowserRoot("ROOT", null)
              }

              override fun onLoadChildren(
                  parentId: String,
                  result: Result<MutableList<MediaBrowserCompat.MediaItem>>
              ) {
                  result.sendResult(mutableListOf())
              }
          }
          EOF

      # ★重要：gradle wrapperや手動インストールは不要。
      # GitHub Actions標準の gradle コマンド（9.3）をそのまま使います。
      - name: Build APK (System Gradle 9.3)
        shell: bash
        run: |
          set -euxo pipefail
          gradle assembleDebug --no-daemon

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: DriveSense-APK
          path: app/build/outputs/apk/debug/app-debug.apk
