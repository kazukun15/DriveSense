name: Build Ambient Flow (Final Static)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Gradle 8.6
        shell: bash
        run: |
          wget -q https://services.gradle.org/distributions/gradle-8.6-bin.zip
          unzip -q gradle-8.6-bin.zip
          echo "$PWD/gradle-8.6/bin" >> $GITHUB_PATH

      - name: Generate Project Files
        shell: bash
        run: |
          set -e
          
          # --- 1. Settings ---
          cat > settings.gradle.kts <<EOF
          pluginManagement { repositories { google(); mavenCentral(); gradlePluginPortal() } }
          dependencyResolutionManagement { repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS); repositories { google(); mavenCentral() } }
          rootProject.name = "AmbientFlow"
          include(":app")
          EOF

          # --- 2. Build Gradle (Project) ---
          cat > build.gradle.kts <<EOF
          plugins {
              id("com.android.application") version "8.3.0" apply false
              id("org.jetbrains.kotlin.android") version "1.9.23" apply false
          }
          EOF

          # --- 3. Gradle Properties ---
          cat > gradle.properties <<EOF
          org.gradle.jvmargs=-Xmx4g -XX:+UseParallelGC
          android.useAndroidX=true
          android.enableJetifier=true
          android.nonTransitiveRClass=true
          android.suppressUnsupportedCompileSdk=35
          EOF

          # --- 4. App Structure ---
          mkdir -p app/src/main/java/jp/kazukun/ambient
          mkdir -p app/src/main/res/xml
          mkdir -p app/src/main/res/values
          mkdir -p app/src/main/res/drawable
          mkdir -p app/src/main/res/mipmap-anydpi-v26

          # --- 5. App Gradle (Car Library Included) ---
          cat > app/build.gradle.kts <<EOF
          plugins { id("com.android.application"); id("org.jetbrains.kotlin.android") }
          android {
              namespace = "jp.kazukun.ambient"
              compileSdk = 35
              defaultConfig {
                  applicationId = "jp.kazukun.ambient"
                  minSdk = 26
                  targetSdk = 35
                  versionCode = 120
                  versionName = "16.0.StaticFix"
              }
              buildTypes { release { isMinifyEnabled = false } }
              compileOptions { sourceCompatibility = JavaVersion.VERSION_17; targetCompatibility = JavaVersion.VERSION_17 }
              kotlinOptions { jvmTarget = "17" }
              lint { 
                  abortOnError = false 
                  checkReleaseBuilds = false
              }
          }
          dependencies {
              implementation("androidx.core:core-ktx:1.12.0")
              implementation("androidx.appcompat:appcompat:1.6.1")
              // Car App Library
              implementation("androidx.car.app:app:1.4.0")
              implementation("com.google.android.gms:play-services-location:21.0.1")
          }
          EOF

          # --- 6. Resources ---
          cat > app/src/main/res/values/strings.xml <<EOF
          <resources><string name="app_name">Ambient Flow</string></resources>
          EOF
          
          # Car App Category (Navigation is Key)
          cat > app/src/main/res/xml/automotive_app_desc.xml <<EOF
          <automotiveApp>
              <uses name="navigation"/>
          </automotiveApp>
          EOF

          # --- Icons ---
          cat > app/src/main/res/drawable/ic_launcher_background.xml <<EOF
          <vector android:width="108dp" android:height="108dp" android:viewportWidth="108" android:viewportHeight="108" xmlns:android="http://schemas.android.com/apk/res/android"><path android:fillColor="#000022" android:pathData="M0,0h108v108h-108z"/></vector>
          EOF
          cat > app/src/main/res/drawable/ic_launcher_foreground.xml <<EOF
          <vector android:width="108dp" android:height="108dp" android:viewportWidth="108" android:viewportHeight="108" xmlns:android="http://schemas.android.com/apk/res/android"><path android:fillColor="#E0E0E0" android:pathData="M54,26 A28,28 0 1,0 54,82 A28,28 0 1,0 54,26 M54,40 A14,14 0 1,1 54,68 A14,14 0 1,1 54,40"/></vector>
          EOF
          cat > app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml <<EOF
          <adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android"><background android:drawable="@drawable/ic_launcher_background"/><foreground android:drawable="@drawable/ic_launcher_foreground"/></adaptive-icon>
          EOF
          cp app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml app/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml

          # --- 7. Manifest ---
          cat > app/src/main/AndroidManifest.xml <<EOF
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android" package="jp.kazukun.ambient">
              <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
              <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
              <uses-permission android:name="android.permission.INTERNET" />
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
              <uses-permission android:name="androidx.car.app.ACCESS_SURFACE" /> 

              <application android:label="Ambient Flow" android:icon="@mipmap/ic_launcher" android:theme="@style/Theme.AppCompat.NoActionBar">
                  <meta-data android:name="com.google.android.gms.car.application" android:resource="@xml/automotive_app_desc" />
                  <meta-data android:name="androidx.car.app.minCarApiLevel" android:value="1" />
                  
                  <service android:name=".AmbientCarService" android:exported="true">
                      <intent-filter>
                          <action android:name="androidx.car.app.CarAppService" />
                          <category android:name="androidx.car.app.category.NAVIGATION"/>
                      </intent-filter>
                  </service>

                  <activity android:name=".MainActivity" android:exported="true">
                      <intent-filter><action android:name="android.intent.action.MAIN" /><category android:name="android.intent.category.LAUNCHER" /></intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF

          # --- 8. MainActivity ---
          cat > app/src/main/java/jp/kazukun/ambient/MainActivity.kt <<EOF
          package jp.kazukun.ambient
          import android.Manifest
          import android.content.pm.PackageManager
          import android.os.Bundle
          import androidx.appcompat.app.AppCompatActivity
          import androidx.core.app.ActivityCompat
          import androidx.core.content.ContextCompat

          class MainActivity : AppCompatActivity() {
              override fun onCreate(savedInstanceState: Bundle?) {
                  super.onCreate(savedInstanceState)
                  // ナビアプリは位置情報必須のためリクエスト
                  if (ContextCompat.checkSelfPermission(this, Manifest.permission.ACCESS_FINE_LOCATION) != PackageManager.PERMISSION_GRANTED) {
                      ActivityCompat.requestPermissions(this, arrayOf(Manifest.permission.ACCESS_FINE_LOCATION), 99)
                  }
              }
          }
          EOF

          # --- 9. Car App Service (Correct Imports & Logic) ---
          cat > app/src/main/java/jp/kazukun/ambient/AmbientCarService.kt <<EOF
          package jp.kazukun.ambient

          import android.Manifest
          import android.content.pm.PackageManager
          import android.graphics.*
          // ★修正: 必須インポート追加
          import android.view.Surface
          import androidx.car.app.CarAppService
          import androidx.car.app.CarContext
          import androidx.car.app.Screen
          import androidx.car.app.Session
          import androidx.car.app.SurfaceCallback
          import androidx.car.app.SurfaceContainer
          import androidx.car.app.model.*
          import androidx.car.app.navigation.model.NavigationTemplate
          import androidx.car.app.validation.HostValidator
          import androidx.core.content.ContextCompat
          import androidx.lifecycle.DefaultLifecycleObserver
          import androidx.lifecycle.LifecycleOwner

          class AmbientCarService : CarAppService() {
              // バリデーター設定（必須）
              override fun createHostValidator() = HostValidator.ALLOW_ALL_HOSTS_VALIDATOR
              override fun onCreateSession() = AmbientSession()
          }

          class AmbientSession : Session() {
              override fun onCreateScreen(intent: android.content.Intent): Screen {
                  return AmbientScreen(carContext)
              }
          }

          class AmbientScreen(carContext: CarContext) : Screen(carContext), DefaultLifecycleObserver {
              private var surface: Surface? = null
              private var width = 0
              private var height = 0
              
              // 描画ツール
              private val textPaint = Paint()
              private val peugeotPaint = Paint()
              private val subPaint = Paint()
              private val bgPaint = Paint()

              // 色モード管理 (0:STAY, 1:FLOW, 2:DRIVE)
              private var currentMode = 0
              private val modeNames = listOf("STAY", "FLOW", "DRIVE")

              init {
                  lifecycle.addObserver(this)
                  initPaints()
              }
              
              private fun initPaints() {
                  textPaint.apply {
                      isAntiAlias = true
                      textAlign = Paint.Align.CENTER
                      color = Color.WHITE
                      textSize = 60f
                      typeface = Typeface.create(Typeface.SERIF, Typeface.BOLD)
                      setShadowLayer(20f, 0f, 0f, Color.BLACK)
                  }
                  
                  // Peugeot Logo (Platinum)
                  peugeotPaint.apply {
                      isAntiAlias = true
                      textAlign = Paint.Align.CENTER
                      color = Color.parseColor("#E5E4E2")
                      textSize = 80f
                      typeface = Typeface.create(Typeface.SANS_SERIF, Typeface.BOLD_ITALIC)
                      setShadowLayer(20f, 0f, 0f, Color.parseColor("#60000000"))
                      letterSpacing = 0.1f
                  }
                  
                  subPaint.apply {
                      isAntiAlias = true
                      textAlign = Paint.Align.CENTER
                      color = Color.parseColor("#B0BEC5")
                      textSize = 40f
                      typeface = Typeface.DEFAULT
                  }
                  bgPaint.isAntiAlias = true
              }

              override fun onGetTemplate(): Template {
                  // ★ボタン設定: 押すと色が切り替わる
                  val action = Action.Builder()
                      .setTitle("Change Color")
                      .setOnClickListener { onModeChange() }
                      .build()

                  val actionStrip = ActionStrip.Builder().addAction(action).build()

                  // ナビゲーションテンプレート（地図エリアはCanvasで描画）
                  return NavigationTemplate.Builder()
                      .setActionStrip(actionStrip)
                      .build()
              }

              // ボタンクリック時の処理
              private fun onModeChange() {
                  currentMode = (currentMode + 1) % 3
                  drawFrame() // ★ここだけ描画（超軽量）
                  invalidate() // テンプレート更新通知
              }

              private val surfaceCallback = object : SurfaceCallback {
                  override fun onSurfaceAvailable(surfaceContainer: SurfaceContainer) {
                      surface = surfaceContainer.surface
                      width = surfaceContainer.width
                      height = surfaceContainer.height
                      // 画面準備完了時に1回だけ描画
                      drawFrame()
                  }
                  override fun onSurfaceDestroyed(surfaceContainer: SurfaceContainer) {
                      surface = null
                  }
              }

              // 1フレーム描画関数（ループなし・安全設計）
              private fun drawFrame() {
                  val s = surface ?: return
                  if (width == 0 || height == 0) return

                  try {
                      val canvas = s.lockCanvas(null) ?: return
                      try {
                          // 背景グラデーション選択
                          val shader = when(currentMode) {
                              0 -> LinearGradient(0f, 0f, 0f, height.toFloat(),
                                      Color.parseColor("#050510"), Color.parseColor("#1A237E"), Shader.TileMode.CLAMP) // Blue (STAY)
                              1 -> LinearGradient(0f, 0f, 0f, height.toFloat(),
                                      Color.parseColor("#00251a"), Color.parseColor("#00695c"), Shader.TileMode.CLAMP) // Teal (FLOW)
                              else -> LinearGradient(0f, 0f, 0f, height.toFloat(),
                                      Color.parseColor("#210000"), Color.parseColor("#b71c1c"), Shader.TileMode.CLAMP) // Red (DRIVE)
                          }
                          
                          bgPaint.shader = shader
                          canvas.drawRect(0f, 0f, width.toFloat(), height.toFloat(), bgPaint)

                          // 文字描画
                          val cx = width / 2f
                          val cy = height / 2f
                          
                          canvas.drawText("Ambient Flow", cx, cy - 100f, textPaint)
                          canvas.drawText("PEUGEOT", cx, cy + 20f, peugeotPaint)
                          canvas.drawText("Mode: " + modeNames[currentMode], cx, cy + 120f, subPaint)

                      } finally {
                          s.unlockCanvasAndPost(canvas)
                      }
                  } catch (e: Exception) {
                      e.printStackTrace()
                  }
              }
              
              override fun onCreate(owner: LifecycleOwner) {
                  carContext.getCarService(androidx.car.app.AppManager::class.java).setSurfaceCallback(surfaceCallback)
              }
          }
          EOF

      - name: Build APK
        shell: bash
        run: |
          set -e
          gradle assembleDebug --no-daemon

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: AmbientFlow-FinalStatic-APK
          path: app/build/outputs/apk/debug/app-debug.apk
