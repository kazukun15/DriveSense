name: Build Peugeot Robust Cockpit

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Gradle 8.6
        shell: bash
        run: |
          set -euxo pipefail
          wget -q https://services.gradle.org/distributions/gradle-8.6-bin.zip
          unzip -q gradle-8.6-bin.zip
          echo "$PWD/gradle-8.6/bin" >> $GITHUB_PATH

      - name: Generate Project Files
        shell: bash
        run: |
          set -euxo pipefail

          # パッケージ名を変更 (キャッシュ汚染回避)
          PKG="jp.kazukun.peugeot.robust"
          APP_LABEL="i-Cockpit"

          # 1. Settings
          cat > settings.gradle.kts <<EOF
          pluginManagement {
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
          }
          dependencyResolutionManagement {
              repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
              repositories {
                  google()
                  mavenCentral()
              }
          }
          rootProject.name = "PeugeotRobust"
          include(":app")
          EOF

          # 2. Build Gradle (Project)
          cat > build.gradle.kts <<EOF
          plugins {
              id("com.android.application") version "8.3.0" apply false
              id("org.jetbrains.kotlin.android") version "1.9.23" apply false
          }
          EOF

          # 3. Gradle Properties
          cat > gradle.properties <<EOF
          org.gradle.jvmargs=-Xmx4g -XX:+UseParallelGC
          android.useAndroidX=true
          android.enableJetifier=true
          kotlin.code.style=official
          android.nonTransitiveRClass=true
          EOF

          # 4. App Module
          mkdir -p app/src/main/{java/jp/kazukun/peugeot/robust,res/xml,res/values,res/drawable,res/mipmap-anydpi-v26}

          cat > app/build.gradle.kts <<EOF
          plugins {
              id("com.android.application")
              id("org.jetbrains.kotlin.android")
          }

          android {
              namespace = "$PKG"
              compileSdk = 34

              defaultConfig {
                  applicationId = "$PKG"
                  minSdk = 26
                  targetSdk = 34
                  versionCode = 1
                  versionName = "1.0.Robust"
              }
              buildTypes {
                  release { isMinifyEnabled = false }
              }
              compileOptions {
                  sourceCompatibility = JavaVersion.VERSION_17
                  targetCompatibility = JavaVersion.VERSION_17
              }
              kotlinOptions { jvmTarget = "17" }
          }

          dependencies {
              implementation("androidx.core:core-ktx:1.12.0")
              implementation("androidx.appcompat:appcompat:1.6.1")
              implementation("androidx.media:media:1.7.0")
              implementation("com.google.android.gms:play-services-location:21.0.1")
              implementation("org.jetbrains.kotlinx:kotlinx-coroutines-android:1.7.3")
          }
          EOF

          # --- Resources ---
          cat > app/src/main/res/values/strings.xml <<EOF
          <resources>
              <string name="app_name">$APP_LABEL</string>
          </resources>
          EOF

          cat > app/src/main/res/xml/automotive_app_desc.xml <<EOF
          <?xml version="1.0" encoding="utf-8"?>
          <automotiveApp xmlns:android="http://schemas.android.com/apk/res/android">
              <uses name="media" />
          </automotiveApp>
          EOF

          # Icons (Peugeot Style)
          cat > app/src/main/res/drawable/ic_launcher_background.xml <<EOF
          <vector xmlns:android="http://schemas.android.com/apk/res/android" android:width="108dp" android:height="108dp" android:viewportWidth="108" android:viewportHeight="108">
              <path android:fillColor="#000000" android:pathData="M0,0h108v108h-108z"/>
          </vector>
          EOF
          cat > app/src/main/res/drawable/ic_launcher_foreground.xml <<EOF
          <vector xmlns:android="http://schemas.android.com/apk/res/android" android:width="108dp" android:height="108dp" android:viewportWidth="108" android:viewportHeight="108">
              <path android:fillColor="#CDA778" android:pathData="M54,18 L24,30 L30,75 L54,90 L78,75 L84,30 L54,18 Z M54,28 L74,38 L70,70 L54,80 L38,70 L34,38 L54,28 Z"/>
          </vector>
          EOF
          cat > app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml <<EOF
          <adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
              <background android:drawable="@drawable/ic_launcher_background"/>
              <foreground android:drawable="@drawable/ic_launcher_foreground"/>
          </adaptive-icon>
          EOF
          cp app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml app/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml

          # Manifest
          cat > app/src/main/AndroidManifest.xml <<EOF
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android" package="$PKG">
              <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
              <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE_LOCATION" />
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE_MEDIA_PLAYBACK" />
              <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />

              <application
                  android:label="$APP_LABEL"
                  android:allowBackup="false"
                  android:supportsRtl="true"
                  android:icon="@mipmap/ic_launcher"
                  android:roundIcon="@mipmap/ic_launcher_round"
                  android:theme="@style/Theme.AppCompat.NoActionBar">

                  <meta-data android:name="com.google.android.gms.car.application" android:resource="@xml/automotive_app_desc" />

                  <service
                      android:name=".LionService"
                      android:exported="true"
                      android:foregroundServiceType="mediaPlayback|location">
                      <intent-filter>
                          <action android:name="android.media.browse.MediaBrowserService" />
                      </intent-filter>
                  </service>

                  <activity
                      android:name=".MainActivity"
                      android:exported="true"
                      android:screenOrientation="landscape"
                      android:launchMode="singleTop">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF

          # --- Kotlin Code ---

          # 1. CockpitRenderer (FIX: Imports, Escaped Shell Vars)
          cat > app/src/main/java/jp/kazukun/peugeot/robust/CockpitRenderer.kt <<EOF
          package $PKG
          import android.graphics.*
          import kotlin.math.* // 重要: 数学関数のインポート

          class CockpitRenderer {
              // Peugeot Color Palette
              private val COLOR_ONYX = Color.BLACK
              private val COLOR_COPPER = Color.rgb(205, 167, 120)
              private val COLOR_KRYPTONITE = Color.rgb(208, 255, 20)
              private val COLOR_ICE = Color.WHITE
              private val COLOR_METAL = Color.parseColor("#424242")

              private val paint = Paint().apply { isAntiAlias = true }
              
              // フォント設定 (文字バッファ確保)
              private val speedPaint = Paint().apply {
                  isAntiAlias = true
                  color = COLOR_ICE
                  textAlign = Paint.Align.CENTER
                  typeface = Typeface.create(Typeface.SANS_SERIF, Typeface.BOLD)
                  setShadowLayer(10f, 0f, 0f, COLOR_KRYPTONITE)
              }
              private val labelPaint = Paint().apply {
                  isAntiAlias = true
                  color = COLOR_COPPER
                  textSize = 24f
                  textAlign = Paint.Align.CENTER
                  letterSpacing = 0.15f
              }
              private val modePaint = Paint().apply {
                  isAntiAlias = true
                  color = Color.LTGRAY
                  textSize = 20f
                  textAlign = Paint.Align.CENTER
              }

              fun draw(canvas: Canvas, width: Int, height: Int, speed: Float, mode: Int, time: Double) {
                  val cx = width / 2f
                  val cy = height / 2f
                  val r = min(width, height) * 0.45f
                  
                  // 1. 背景：グラデーション
                  val shader = LinearGradient(0f, 0f, 0f, height.toFloat(),
                      intArrayOf(Color.BLACK, Color.parseColor("#1a1a1a"), Color.BLACK),
                      null, Shader.TileMode.CLAMP)
                  paint.shader = shader
                  paint.style = Paint.Style.FILL
                  canvas.drawRect(0f, 0f, width.toFloat(), height.toFloat(), paint)
                  paint.shader = null

                  // 2. 六角形フレーム
                  paint.style = Paint.Style.STROKE
                  paint.strokeWidth = 6f
                  paint.color = if (mode == 0) COLOR_COPPER else COLOR_KRYPTONITE
                  paint.alpha = 255
                  
                  val path = Path()
                  for (i in 0..6) {
                      val angle = (i * 60 - 30) * (PI / 180.0) // kotlin.mathを使用
                      val x = cx + r * cos(angle).toFloat()
                      val y = cy + r * sin(angle).toFloat()
                      if (i == 0) path.moveTo(x, y) else path.lineTo(x, y)
                  }
                  path.close()
                  canvas.drawPath(path, paint)

                  // 3. 速度バー (Claws)
                  paint.style = Paint.Style.FILL
                  paint.strokeWidth = 0f
                  val speedRatio = (speed / 180f).coerceIn(0f, 1f)
                  val barWidth = r * 0.9f
                  val barHeight = 15f
                  val barY = cy + r * 0.2f
                  
                  // 左
                  paint.color = COLOR_METAL
                  canvas.drawRect(cx - barWidth, barY, cx - 40, barY + barHeight, paint)
                  paint.color = if (mode == 0) COLOR_ICE else COLOR_KRYPTONITE
                  val leftFill = (barWidth - 40) * speedRatio
                  if (leftFill > 0) {
                      canvas.drawRect(cx - barWidth, barY, cx - barWidth + leftFill, barY + barHeight, paint)
                  }

                  // 右
                  paint.color = COLOR_METAL
                  canvas.drawRect(cx + 40, barY, cx + barWidth, barY + barHeight, paint)
                  paint.color = if (mode == 0) COLOR_ICE else COLOR_KRYPTONITE
                  val rightFill = (barWidth - 40) * speedRatio
                  if (rightFill > 0) {
                      canvas.drawRect(cx + 40 + (barWidth - 40 - rightFill), barY, cx + barWidth, barY + barHeight, paint)
                  }

                  // 4. 文字情報
                  speedPaint.textSize = min(width, height) * 0.25f
                  val textHeight = speedPaint.descent() - speedPaint.ascent()
                  val textOffset = (textHeight / 2) - speedPaint.descent()
                  // toString()のエスケープは不要だが、念のため安全に記述
                  val speedStr = speed.toInt().toString()
                  canvas.drawText(speedStr, cx, cy + textOffset - 20f, speedPaint)

                  labelPaint.textSize = min(width, height) * 0.08f
                  labelPaint.color = if (mode == 0) COLOR_COPPER else COLOR_KRYPTONITE
                  canvas.drawText("KM/H", cx, cy + r * 0.6f, labelPaint)
                  
                  modePaint.textSize = min(width, height) * 0.06f
                  val modeText = if (mode == 0) "COMFORT" else "SPORT"
                  canvas.drawText(modeText, cx, cy - r * 0.6f, modePaint)
              }
          }
          EOF

          # 2. MainActivity
          cat > app/src/main/java/jp/kazukun/peugeot/robust/MainActivity.kt <<EOF
          package $PKG
          import android.Manifest
          import android.content.Context
          import android.content.Intent
          import android.content.pm.PackageManager
          import android.graphics.Canvas
          import android.location.Location
          import android.location.LocationListener
          import android.location.LocationManager
          import android.os.Build
          import android.os.Bundle
          import android.view.View
          import android.view.WindowManager
          import androidx.appcompat.app.AppCompatActivity
          import androidx.core.app.ActivityCompat
          import androidx.core.content.ContextCompat

          class PhoneCockpitView(context: Context) : View(context) {
              private val renderer = CockpitRenderer()
              var currentSpeed = 0f
              var currentMode = 0
              var time = 0.0
              
              override fun onDraw(canvas: Canvas) {
                  super.onDraw(canvas)
                  renderer.draw(canvas, width, height, currentSpeed, currentMode, time)
                  time += 0.05
                  invalidate()
              }
          }

          class MainActivity : AppCompatActivity(), LocationListener {
              private lateinit var cockpitView: PhoneCockpitView
              private var locationManager: LocationManager? = null

              override fun onCreate(savedInstanceState: Bundle?) {
                  super.onCreate(savedInstanceState)
                  window.addFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON)
                  cockpitView = PhoneCockpitView(this)
                  setContentView(cockpitView)
                  
                  cockpitView.setOnClickListener {
                      cockpitView.currentMode = (cockpitView.currentMode + 1) % 2
                  }
                  checkPermissions()
              }

              private fun checkPermissions() {
                  val perms = mutableListOf(Manifest.permission.ACCESS_FINE_LOCATION)
                  if (Build.VERSION.SDK_INT >= 33) perms.add(Manifest.permission.POST_NOTIFICATIONS)
                  
                  val missing = perms.filter { ContextCompat.checkSelfPermission(this, it) != PackageManager.PERMISSION_GRANTED }
                  if (missing.isNotEmpty()) {
                      ActivityCompat.requestPermissions(this, missing.toTypedArray(), 99)
                  } else {
                      startServices()
                  }
              }

              override fun onRequestPermissionsResult(requestCode: Int, permissions: Array<out String>, grantResults: IntArray) {
                  super.onRequestPermissionsResult(requestCode, permissions, grantResults)
                  if (grantResults.isNotEmpty() && grantResults.all { it == PackageManager.PERMISSION_GRANTED }) {
                      startServices()
                  }
              }

              private fun startServices() {
                  locationManager = getSystemService(Context.LOCATION_SERVICE) as LocationManager
                  try {
                      locationManager?.requestLocationUpdates(LocationManager.GPS_PROVIDER, 100, 0f, this)
                  } catch (e: SecurityException) { e.printStackTrace() }

                  try {
                      val intent = Intent(this, LionService::class.java)
                      if (Build.VERSION.SDK_INT >= 26) startForegroundService(intent) else startService(intent)
                  } catch (e: Exception) { e.printStackTrace() }
              }

              override fun onLocationChanged(location: Location) {
                  cockpitView.currentSpeed = location.speed * 3.6f
              }
              
              override fun onStatusChanged(p: String?, s: Int, e: Bundle?) {}
              override fun onProviderEnabled(p: String) {}
              override fun onProviderDisabled(p: String) {}
          }
          EOF

          # 3. LionService (FIX: Escaping, Try-Catch, Traffic Control)
          cat > app/src/main/java/jp/kazukun/peugeot/robust/LionService.kt <<EOF
          package $PKG

          import android.Manifest
          import android.app.NotificationChannel
          import android.app.NotificationManager
          import android.content.Context
          import android.content.pm.PackageManager
          import android.graphics.Bitmap
          import android.graphics.Canvas
          import android.location.Location
          import android.location.LocationListener
          import android.location.LocationManager
          import android.os.Build
          import android.os.Bundle
          import android.support.v4.media.MediaBrowserCompat
          import android.support.v4.media.MediaMetadataCompat
          import android.support.v4.media.session.MediaSessionCompat
          import android.support.v4.media.session.PlaybackStateCompat
          import androidx.core.app.NotificationCompat
          import androidx.core.content.ContextCompat
          import androidx.media.MediaBrowserServiceCompat
          import kotlinx.coroutines.*

          class LionService : MediaBrowserServiceCompat(), LocationListener {
              private lateinit var mediaSession: MediaSessionCompat
              private var locationManager: LocationManager? = null
              private val renderScope = CoroutineScope(Dispatchers.Default + Job())
              
              private val renderer = CockpitRenderer()
              // 通信負荷対策: 解像度320px
              private val WIDTH = 320
              private val HEIGHT = 320
              private val bitmap = Bitmap.createBitmap(WIDTH, HEIGHT, Bitmap.Config.ARGB_8888)
              private val canvas = Canvas(bitmap)
              
              private var currentSpeed = 0f
              private var currentMode = 0
              private var time = 0.0

              override fun onCreate() {
                  super.onCreate()
                  startForegroundNotification()

                  mediaSession = MediaSessionCompat(this, "PeugeotSession").apply {
                      setCallback(object : MediaSessionCompat.Callback() {
                          override fun onPlay() { currentMode = (currentMode+1)%2; forceUpdate() }
                          override fun onPause() { currentMode = (currentMode+1)%2; forceUpdate() }
                          override fun onSkipToNext() { currentMode = (currentMode+1)%2; forceUpdate() }
                      })
                      isActive = true
                      setPlaybackState(PlaybackStateCompat.Builder()
                          .setActions(PlaybackStateCompat.ACTION_PLAY or PlaybackStateCompat.ACTION_PAUSE or PlaybackStateCompat.ACTION_SKIP_TO_NEXT)
                          .setState(PlaybackStateCompat.STATE_PLAYING, 0L, 1.0f)
                          .build())
                      sessionToken = mediaSession.sessionToken
                  }
                  
                  setupLocation()
                  
                  // Auto用ループ: 1秒間隔 (1fps) で通信を保護
                  renderScope.launch {
                      while (isActive) {
                          updateMetadata()
                          time += 0.5 
                          delay(1000)
                      }
                  }
              }
              
              private fun forceUpdate() {
                  renderScope.launch { updateMetadata() }
              }

              private fun startForegroundNotification() {
                  val chId = "peugeot_srv_id"
                  if (Build.VERSION.SDK_INT >= 26) {
                      val ch = NotificationChannel(chId, "Cockpit Service", NotificationManager.IMPORTANCE_LOW)
                      getSystemService(NotificationManager::class.java).createNotificationChannel(ch)
                  }
                  val notif = NotificationCompat.Builder(this, chId)
                      .setContentTitle("i-Cockpit Active")
                      .setSmallIcon(android.R.drawable.ic_media_play)
                      .setOngoing(true)
                      .build()
                  try {
                      if (Build.VERSION.SDK_INT >= 34) {
                          startForeground(102, notif, 
                              android.content.pm.ServiceInfo.FOREGROUND_SERVICE_TYPE_MEDIA_PLAYBACK or 
                              android.content.pm.ServiceInfo.FOREGROUND_SERVICE_TYPE_LOCATION)
                      } else {
                          startForeground(102, notif)
                      }
                  } catch (e: Exception) { e.printStackTrace() }
              }

              private fun setupLocation() {
                  if (ContextCompat.checkSelfPermission(this, Manifest.permission.ACCESS_FINE_LOCATION) == PackageManager.PERMISSION_GRANTED) {
                      locationManager = getSystemService(Context.LOCATION_SERVICE) as LocationManager
                      try {
                          locationManager?.requestLocationUpdates(LocationManager.GPS_PROVIDER, 1000, 0f, this)
                      } catch (e: Exception) { e.printStackTrace() }
                  }
              }

              override fun onLocationChanged(location: Location) {
                  currentSpeed = location.speed * 3.6f
              }

              private fun updateMetadata() {
                  try {
                      // Canvas描画
                      renderer.draw(canvas, WIDTH, HEIGHT, currentSpeed, currentMode, time)
                      
                      // エスケープ処理: \$ を使用してシェル展開を回避
                      val meta = MediaMetadataCompat.Builder()
                          .putString(MediaMetadataCompat.METADATA_KEY_TITLE, "i-Cockpit")
                          .putString(MediaMetadataCompat.METADATA_KEY_ARTIST, "\${currentSpeed.toInt()} km/h")
                          .putBitmap(MediaMetadataCompat.METADATA_KEY_ALBUM_ART, bitmap)
                          .build()
                      
                      mediaSession.setMetadata(meta)
                  } catch (e: Exception) {
                      // エラー発生時もクラッシュさせない
                      e.printStackTrace()
                  }
              }

              override fun onLoadChildren(parentId: String, result: Result<MutableList<MediaBrowserCompat.MediaItem>>) {
                  result.sendResult(mutableListOf())
              }
              override fun onGetRoot(pkg: String, uid: Int, root: Bundle?): BrowserRoot {
                  return BrowserRoot("ROOT", null)
              }
              override fun onDestroy() {
                  renderScope.cancel()
                  locationManager?.removeUpdates(this)
                  mediaSession.release()
                  super.onDestroy()
              }
              override fun onStatusChanged(p: String?, s: Int, e: Bundle?) {}
              override fun onProviderEnabled(p: String) {}
              override fun onProviderDisabled(p: String) {}
          }
          EOF

      - name: Build APK
        shell: bash
        run: |
          set -euxo pipefail
          gradle assembleDebug --no-daemon

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Peugeot-Robust-APK
          path: app/build/outputs/apk/debug/app-debug.apk
