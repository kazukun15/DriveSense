name: Build Ambient Flow (Perfect Mix)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Gradle 8.6
        shell: bash
        run: |
          wget -q https://services.gradle.org/distributions/gradle-8.6-bin.zip
          unzip -q gradle-8.6-bin.zip
          echo "$PWD/gradle-8.6/bin" >> $GITHUB_PATH

      - name: Generate Project Files
        shell: bash
        run: |
          set -e
          PKG="jp.kazukun.ambient"
          APP_LABEL="Ambient Flow"

          # 1. Settings
          cat > settings.gradle.kts <<EOF
          pluginManagement {
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
          }
          dependencyResolutionManagement {
              repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
              repositories {
                  google()
                  mavenCentral()
              }
          }
          rootProject.name = "AmbientFlow"
          include(":app")
          EOF

          # 2. Build Gradle
          cat > build.gradle.kts <<EOF
          plugins {
              id("com.android.application") version "8.3.0" apply false
              id("org.jetbrains.kotlin.android") version "1.9.23" apply false
          }
          EOF

          # 3. Gradle Properties
          cat > gradle.properties <<EOF
          org.gradle.jvmargs=-Xmx4g -XX:+UseParallelGC
          android.useAndroidX=true
          android.enableJetifier=true
          kotlin.code.style=official
          android.nonTransitiveRClass=true
          EOF

          # 4. App Folders
          mkdir -p app/src/main/java/jp/kazukun/ambient
          mkdir -p app/src/main/res/xml
          mkdir -p app/src/main/res/values
          mkdir -p app/src/main/res/drawable
          mkdir -p app/src/main/res/mipmap-anydpi-v26

          # 5. App build.gradle
          cat > app/build.gradle.kts <<EOF
          plugins {
              id("com.android.application")
              id("org.jetbrains.kotlin.android")
          }

          android {
              namespace = "$PKG"
              compileSdk = 35
              defaultConfig {
                  applicationId = "$PKG"
                  minSdk = 26
                  targetSdk = 35
                  versionCode = 15
                  versionName = "8.0.PerfectMix"
              }
              buildTypes { release { isMinifyEnabled = false } }
              compileOptions {
                  sourceCompatibility = JavaVersion.VERSION_17
                  targetCompatibility = JavaVersion.VERSION_17
              }
              kotlinOptions { jvmTarget = "17" }
          }

          dependencies {
              implementation("androidx.core:core-ktx:1.12.0")
              implementation("androidx.appcompat:appcompat:1.6.1")
              implementation("androidx.media:media:1.7.0")
              implementation("com.google.android.gms:play-services-location:21.0.1")
              implementation("org.jetbrains.kotlinx:kotlinx-coroutines-android:1.7.3")
          }
          EOF

          # 6. Resources
          cat > app/src/main/res/values/strings.xml <<EOF
          <resources>
              <string name="app_name">$APP_LABEL</string>
              <string name="status_channel">Ambient Status</string>
          </resources>
          EOF

          cat > app/src/main/res/xml/automotive_app_desc.xml <<EOF
          <?xml version="1.0" encoding="utf-8"?>
          <automotiveApp xmlns:android="http://schemas.android.com/apk/res/android">
              <uses name="media" />
          </automotiveApp>
          EOF

          # Icons
          cat > app/src/main/res/drawable/ic_launcher_background.xml <<EOF
          <vector xmlns:android="http://schemas.android.com/apk/res/android" android:width="108dp" android:height="108dp" android:viewportWidth="108" android:viewportHeight="108">
              <path android:fillColor="#121212" android:pathData="M0,0h108v108h-108z"/>
          </vector>
          EOF
          cat > app/src/main/res/drawable/ic_launcher_foreground.xml <<EOF
          <vector xmlns:android="http://schemas.android.com/apk/res/android" android:width="108dp" android:height="108dp" android:viewportWidth="108" android:viewportHeight="108">
              <path android:fillColor="#FFFFFF" android:pathData="M54,26 A28,28 0 1,0 54,82 A28,28 0 1,0 54,26 M54,40 A14,14 0 1,1 54,68 A14,14 0 1,1 54,40"/>
          </vector>
          EOF
          cat > app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml <<EOF
          <adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
              <background android:drawable="@drawable/ic_launcher_background"/>
              <foreground android:drawable="@drawable/ic_launcher_foreground"/>
          </adaptive-icon>
          EOF
          cp app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml app/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml

          # 7. Manifest
          cat > app/src/main/AndroidManifest.xml <<EOF
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android" package="$PKG">
              <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
              <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE_LOCATION" />
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE_MEDIA_PLAYBACK" />
              <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />

              <application
                  android:label="$APP_LABEL"
                  android:icon="@mipmap/ic_launcher"
                  android:theme="@style/Theme.AppCompat.NoActionBar">
                  <meta-data android:name="com.google.android.gms.car.application" android:resource="@xml/automotive_app_desc" />
                  <service android:name=".AmbientMediaService" android:exported="true" android:foregroundServiceType="location|mediaPlayback">
                      <intent-filter><action android:name="android.media.browse.MediaBrowserService" /></intent-filter>
                  </service>
                  <activity android:name=".MainActivity" android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF

          # 8. MainActivity
          cat > app/src/main/java/jp/kazukun/ambient/MainActivity.kt <<EOF
          package $PKG
          import android.Manifest
          import android.content.*
          import android.content.pm.PackageManager
          import android.os.*
          import androidx.appcompat.app.AppCompatActivity
          import androidx.core.app.ActivityCompat
          import androidx.core.content.ContextCompat

          class MainActivity : AppCompatActivity() {
              override fun onCreate(savedInstanceState: Bundle?) {
                  super.onCreate(savedInstanceState)
                  val perms = mutableListOf(Manifest.permission.ACCESS_FINE_LOCATION)
                  if (Build.VERSION.SDK_INT >= 33) perms.add(Manifest.permission.POST_NOTIFICATIONS)
                  if (perms.any { ContextCompat.checkSelfPermission(this, it) != PackageManager.PERMISSION_GRANTED }) {
                      ActivityCompat.requestPermissions(this, perms.toTypedArray(), 99)
                  } else {
                      startServiceSafe()
                  }
              }
              private fun startServiceSafe() {
                  try { startForegroundService(Intent(this, AmbientMediaService::class.java)) } catch (e: Exception) {}
              }
          }
          EOF

          # 9. Service (Phantom Player Logic)
          cat > app/src/main/java/jp/kazukun/ambient/AmbientMediaService.kt <<EOF
          package $PKG

          import android.Manifest
          import android.app.*
          import android.content.Context
          import android.content.Intent
          import android.content.pm.PackageManager
          import android.graphics.*
          import android.location.*
          import android.os.Bundle
          import android.support.v4.media.*
          import android.support.v4.media.session.*
          import androidx.core.app.NotificationCompat
          import androidx.core.content.ContextCompat
          import androidx.media.MediaBrowserServiceCompat
          import androidx.media.app.NotificationCompat.MediaStyle
          import kotlinx.coroutines.*

          class AmbientMediaService : MediaBrowserServiceCompat(), LocationListener {
              private lateinit var mediaSession: MediaSessionCompat
              private val scope = CoroutineScope(Dispatchers.Default + Job())
              
              private val BITMAP_SIZE = 800
              private val bitmap = Bitmap.createBitmap(BITMAP_SIZE, BITMAP_SIZE, Bitmap.Config.ARGB_8888)
              private val canvas = Canvas(bitmap)
              
              private val textPaint = Paint().apply {
                  isAntiAlias = true
                  textAlign = Paint.Align.CENTER
                  color = Color.parseColor("#EEEEEE")
                  textSize = 100f
                  typeface = Typeface.create(Typeface.SERIF, Typeface.BOLD)
                  setShadowLayer(25f, 0f, 10f, Color.BLACK)
              }
              private val bgPaint = Paint().apply { isAntiAlias = true }

              private val stayShader = LinearGradient(0f, 0f, 0f, BITMAP_SIZE.toFloat(), Color.parseColor("#050c1f"), Color.parseColor("#121a3a"), Shader.TileMode.CLAMP)
              private val flowShader = LinearGradient(0f, 0f, 0f, BITMAP_SIZE.toFloat(), Color.parseColor("#002121"), Color.parseColor("#006064"), Shader.TileMode.CLAMP)
              private val driveShader = LinearGradient(0f, 0f, 0f, BITMAP_SIZE.toFloat(), Color.parseColor("#310000"), Color.parseColor("#b71c1c"), Shader.TileMode.CLAMP)

              override fun onCreate() {
                  super.onCreate()
                  
                  mediaSession = MediaSessionCompat(this, "AmbientSession").apply {
                      setCallback(object : MediaSessionCompat.Callback() {
                          override fun onPlay() { 
                              // 再生ボタンが押されても何もしない（オーディオフォーカスを取らないため）
                              updatePlaybackState(PlaybackStateCompat.STATE_PLAYING)
                          }
                          override fun onPause() { 
                              // 一時停止状態にするが、画面は維持したい
                              updatePlaybackState(PlaybackStateCompat.STATE_PAUSED)
                          }
                      })
                      isActive = true
                      
                      // ★ここが最重要：Audio Focusを取らずに「再生中」と宣言する
                      // これにより画面はアクティブになるが、他アプリの音を消さない可能性が高まる
                      setPlaybackState(PlaybackStateCompat.Builder()
                          .setActions(PlaybackStateCompat.ACTION_PLAY or PlaybackStateCompat.ACTION_PAUSE)
                          .setState(PlaybackStateCompat.STATE_PLAYING, 0L, 1.0f)
                          .build())
                  }
                  sessionToken = mediaSession.sessionToken

                  if (ContextCompat.checkSelfPermission(this, Manifest.permission.ACCESS_FINE_LOCATION) == PackageManager.PERMISSION_GRANTED) {
                      (getSystemService(Context.LOCATION_SERVICE) as LocationManager).requestLocationUpdates(LocationManager.GPS_PROVIDER, 2000, 2f, this)
                  }
                  updateState("READY", stayShader)
              }

              // 状態を更新するヘルパー
              private fun updatePlaybackState(state: Int) {
                  mediaSession.setPlaybackState(PlaybackStateCompat.Builder()
                      .setActions(PlaybackStateCompat.ACTION_PLAY or PlaybackStateCompat.ACTION_PAUSE)
                      .setState(state, 0L, 1.0f)
                      .build())
              }

              private fun updateState(text: String, shader: Shader) {
                  scope.launch {
                      bgPaint.shader = shader
                      canvas.drawRect(0f, 0f, BITMAP_SIZE.toFloat(), BITMAP_SIZE.toFloat(), bgPaint)
                      canvas.drawText(text, (BITMAP_SIZE/2).toFloat(), (BITMAP_SIZE/2).toFloat() + 35f, textPaint)

                      withContext(Dispatchers.Main) {
                          // ★メタデータをセットして全画面表示を誘発
                          mediaSession.setMetadata(MediaMetadataCompat.Builder()
                              .putString(MediaMetadataCompat.METADATA_KEY_TITLE, text)
                              .putString(MediaMetadataCompat.METADATA_KEY_ARTIST, "Visual Mode")
                              .putBitmap(MediaMetadataCompat.METADATA_KEY_ALBUM_ART, bitmap)
                              .putBitmap(MediaMetadataCompat.METADATA_KEY_DISPLAY_ICON, bitmap)
                              .build())
                          
                          // 再生状態を「再生中」に強制維持（画面を消さないため）
                          if (mediaSession.controller.playbackState.state != PlaybackStateCompat.STATE_PLAYING) {
                              updatePlaybackState(PlaybackStateCompat.STATE_PLAYING)
                          }

                          val notification = NotificationCompat.Builder(this@AmbientMediaService, "ambient_status_channel")
                              .setContentTitle("Ambient Flow").setContentText(text)
                              .setSmallIcon(R.drawable.ic_launcher_foreground).setLargeIcon(bitmap)
                              .setStyle(MediaStyle().setMediaSession(mediaSession.sessionToken))
                              .build()
                          
                          val mgr = getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager
                          if (Build.VERSION.SDK_INT >= 26) {
                              mgr.createNotificationChannel(NotificationChannel("ambient_status_channel", "Status", NotificationManager.IMPORTANCE_LOW))
                          }
                          startForeground(777, notification)
                      }
                  }
              }

              override fun onLocationChanged(l: Location) {
                  val s = l.speed * 3.6f
                  if (s < 5) updateState("STAY", stayShader) else if (s < 60) updateState("FLOW", flowShader) else updateState("DRIVE", driveShader)
              }

              override fun onGetRoot(p: String, u: Int, r: Bundle?): BrowserRoot? = BrowserRoot("ROOT", null)
              override fun onLoadChildren(i: String, r: Result<MutableList<MediaBrowserCompat.MediaItem>>) { r.sendResult(mutableListOf()) }
          }
          EOF

      - name: Build APK
        run: gradle assembleDebug --no-daemon

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: AmbientFlow-PerfectMix-APK
          path: app/build/outputs/apk/debug/app-debug.apk
