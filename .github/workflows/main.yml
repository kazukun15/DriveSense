name: Build Ambient Flow (Weather & Silent)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Gradle 8.6
        shell: bash
        run: |
          set -euxo pipefail
          wget -q https://services.gradle.org/distributions/gradle-8.6-bin.zip
          unzip -q gradle-8.6-bin.zip
          echo "$PWD/gradle-8.6/bin" >> $GITHUB_PATH

      - name: Generate Project Files
        shell: bash
        run: |
          set -euxo pipefail

          PKG="com.example.ambientflow"
          APP_LABEL="Ambient Flow"

          # 1. Settings
          cat > settings.gradle.kts <<EOF
          pluginManagement {
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
          }
          dependencyResolutionManagement {
              repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
              repositories {
                  google()
                  mavenCentral()
              }
          }
          rootProject.name = "AmbientFlow"
          include(":app")
          EOF

          # 2. Project Build Gradle
          cat > build.gradle.kts <<EOF
          plugins {
              id("com.android.application") version "8.3.0" apply false
              id("org.jetbrains.kotlin.android") version "1.9.23" apply false
          }
          EOF

          # 3. Gradle Properties
          cat > gradle.properties <<EOF
          org.gradle.jvmargs=-Xmx4g -XX:+UseParallelGC
          android.useAndroidX=true
          android.enableJetifier=true
          kotlin.code.style=official
          android.nonTransitiveRClass=true
          EOF

          # 4. App Module
          mkdir -p app/src/main/{java/com/example/ambientflow,res/xml,res/values,res/drawable,res/mipmap-anydpi-v26}

          cat > app/build.gradle.kts <<EOF
          plugins {
              id("com.android.application")
              id("org.jetbrains.kotlin.android")
          }

          android {
              namespace = "$PKG"
              compileSdk = 34

              defaultConfig {
                  applicationId = "$PKG"
                  minSdk = 26
                  targetSdk = 34
                  versionCode = 1
                  versionName = "4.0.Weather"
              }
              buildTypes {
                  release {
                      isMinifyEnabled = true
                      proguardFiles(getDefaultProguardFile("proguard-android-optimize.txt"), "proguard-rules.pro")
                  }
              }
              compileOptions {
                  sourceCompatibility = JavaVersion.VERSION_17
                  targetCompatibility = JavaVersion.VERSION_17
              }
              kotlinOptions { jvmTarget = "17" }
          }

          dependencies {
              implementation("androidx.core:core-ktx:1.12.0")
              implementation("androidx.appcompat:appcompat:1.6.1")
              implementation("androidx.media:media:1.7.0")
              implementation("com.google.android.gms:play-services-location:21.0.1")
              implementation("org.jetbrains.kotlinx:kotlinx-coroutines-android:1.7.3")
          }
          EOF

          # --- Resources ---
          cat > app/src/main/res/values/strings.xml <<EOF
          <resources>
              <string name="app_name">$APP_LABEL</string>
          </resources>
          EOF

          cat > app/src/main/res/xml/automotive_app_desc.xml <<EOF
          <?xml version="1.0" encoding="utf-8"?>
          <automotiveApp xmlns:android="http://schemas.android.com/apk/res/android">
              <uses name="media" />
          </automotiveApp>
          EOF

          # Icons
          cat > app/src/main/res/drawable/ic_launcher_background.xml <<EOF
          <vector xmlns:android="http://schemas.android.com/apk/res/android"
              android:width="108dp" android:height="108dp"
              android:viewportWidth="108" android:viewportHeight="108">
              <path android:fillColor="#212121" android:pathData="M0,0h108v108h-108z"/>
          </vector>
          EOF
          cat > app/src/main/res/drawable/ic_launcher_foreground.xml <<EOF
          <vector xmlns:android="http://schemas.android.com/apk/res/android"
              android:width="108dp" android:height="108dp"
              android:viewportWidth="108" android:viewportHeight="108">
              <path android:fillColor="#00E5FF" android:pathData="M54,26 A28,28 0 1,0 54,82 A28,28 0 1,0 54,26 M54,40 A14,14 0 1,1 54,68 A14,14 0 1,1 54,40"/>
          </vector>
          EOF
          cat > app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml <<EOF
          <adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
              <background android:drawable="@drawable/ic_launcher_background"/>
              <foreground android:drawable="@drawable/ic_launcher_foreground"/>
          </adaptive-icon>
          EOF
          cp app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml app/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml

          # Manifest
          cat > app/src/main/AndroidManifest.xml <<EOF
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android" package="$PKG">
              <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
              <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE_LOCATION" />
              <uses-permission android:name="android.permission.INTERNET" />

              <application
                  android:label="$APP_LABEL"
                  android:allowBackup="false"
                  android:supportsRtl="true"
                  android:icon="@mipmap/ic_launcher"
                  android:roundIcon="@mipmap/ic_launcher_round"
                  android:theme="@style/Theme.AppCompat.NoActionBar">

                  <meta-data
                      android:name="com.google.android.gms.car.application"
                      android:resource="@xml/automotive_app_desc" />

                  <service
                      android:name=".AmbientMediaService"
                      android:exported="true"
                      android:foregroundServiceType="location">
                      <intent-filter>
                          <action android:name="android.media.browse.MediaBrowserService" />
                      </intent-filter>
                  </service>

                  <activity
                      android:name=".MainActivity"
                      android:exported="true"
                      android:launchMode="singleTop">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF

          # --- Kotlin Code ---
          # 1. MainActivity
          cat > app/src/main/java/com/example/ambientflow/MainActivity.kt <<EOF
          package $PKG
          import android.Manifest
          import android.content.pm.PackageManager
          import android.os.Bundle
          import androidx.appcompat.app.AppCompatActivity
          import androidx.core.app.ActivityCompat
          import androidx.core.content.ContextCompat

          class MainActivity : AppCompatActivity() {
              override fun onCreate(savedInstanceState: Bundle?) {
                  super.onCreate(savedInstanceState)
                  // 権限リクエスト
                  val perms = arrayOf(Manifest.permission.ACCESS_FINE_LOCATION)
                  if (ContextCompat.checkSelfPermission(this, perms[0]) != PackageManager.PERMISSION_GRANTED) {
                      ActivityCompat.requestPermissions(this, perms, 99)
                  }
              }
          }
          EOF

          # 2. AmbientMediaService (天気・速度連動ビジュアライザー)
          cat > app/src/main/java/com/example/ambientflow/AmbientMediaService.kt <<EOF
          package $PKG

          import android.Manifest
          import android.content.Context
          import android.content.pm.PackageManager
          import android.graphics.Bitmap
          import android.graphics.Color
          import android.location.Location
          import android.location.LocationListener
          import android.location.LocationManager
          import android.os.Bundle
          import android.support.v4.media.MediaBrowserCompat
          import android.support.v4.media.MediaMetadataCompat
          import android.support.v4.media.session.MediaSessionCompat
          import android.support.v4.media.session.PlaybackStateCompat
          import androidx.core.content.ContextCompat
          import androidx.media.MediaBrowserServiceCompat
          import kotlinx.coroutines.*
          import org.json.JSONObject
          import java.net.URL
          import kotlin.math.*

          class AmbientMediaService : MediaBrowserServiceCompat(), LocationListener {
              private lateinit var mediaSession: MediaSessionCompat
              private var locationManager: LocationManager? = null
              
              private val renderScope = CoroutineScope(Dispatchers.Default + Job())
              private var isRunning = false
              
              // 状態変数
              private var currentSpeedFactor = 0.1f
              private var time = 0.0
              
              // 天気による色調整 (R,G,B の重み)
              private var colorR = 1.0
              private var colorG = 1.0
              private var colorB = 1.0
              private var weatherState = "Loading..."

              // 解像度
              private val WIDTH = 512
              private val HEIGHT = 512
              private val pixels = IntArray(WIDTH * HEIGHT)
              private val bitmap = Bitmap.createBitmap(WIDTH, HEIGHT, Bitmap.Config.ARGB_8888)

              override fun onCreate() {
                  super.onCreate()
                  setupMediaSession()
                  setupLocation()
                  startRendering()
                  // 天気取得ループ開始
                  startWeatherUpdates()
              }

              private fun setupMediaSession() {
                  mediaSession = MediaSessionCompat(this, "AmbientFlowSession").apply {
                      setCallback(object : MediaSessionCompat.Callback() {})
                      isActive = true
                      
                      // ★重要：オーディオフォーカスを要求しない設定
                      // AudioAttributesなどをあえて設定せず、再生状態のみ通知する
                      setPlaybackState(PlaybackStateCompat.Builder()
                          .setActions(PlaybackStateCompat.ACTION_PLAY or PlaybackStateCompat.ACTION_PAUSE)
                          .setState(PlaybackStateCompat.STATE_PLAYING, 0L, 1.0f)
                          .build())

                      // 初期表示
                      updateMetadata(bitmap)
                  }
                  sessionToken = mediaSession.sessionToken
              }

              private fun setupLocation() {
                  if (ContextCompat.checkSelfPermission(this, Manifest.permission.ACCESS_FINE_LOCATION) == PackageManager.PERMISSION_GRANTED) {
                      locationManager = getSystemService(Context.LOCATION_SERVICE) as LocationManager
                      try {
                          locationManager?.requestLocationUpdates(LocationManager.GPS_PROVIDER, 1000, 1f, this)
                      } catch (e: Exception) { e.printStackTrace() }
                  }
              }

              // 天気API (Open-Meteo) から情報を取得
              private fun startWeatherUpdates() {
                  renderScope.launch(Dispatchers.IO) {
                      while (isActive && isRunning) {
                          try {
                              val loc = locationManager?.getLastKnownLocation(LocationManager.GPS_PROVIDER)
                              if (loc != null) {
                                  val url = "https://api.open-meteo.com/v1/forecast?latitude=\${loc.latitude}&longitude=\${loc.longitude}&current_weather=true"
                                  val json = URL(url).readText()
                                  val current = JSONObject(json).getJSONObject("current_weather")
                                  val code = current.getInt("weathercode")
                                  
                                  // 天気コードに基づく色変化
                                  updateWeatherColor(code)
                              }
                          } catch (e: Exception) {
                              e.printStackTrace()
                          }
                          delay(10 * 60 * 1000) // 10分ごとに更新
                      }
                  }
              }

              private fun updateWeatherColor(code: Int) {
                  // WMO Weather interpretation codes
                  when (code) {
                      0, 1 -> { // 快晴
                          weatherState = "Sunny"
                          setColor(1.2, 0.8, 0.4) // 金色・オレンジ系
                      }
                      2, 3 -> { // 曇り
                          weatherState = "Cloudy"
                          setColor(0.8, 0.9, 1.0) // シルバー・白系
                      }
                      in 51..67, in 80..82 -> { // 雨
                          weatherState = "Rainy"
                          setColor(0.4, 0.6, 1.3) // 深い青・紫系
                      }
                      in 71..77, in 85..86 -> { // 雪
                          weatherState = "Snowy"
                          setColor(0.9, 1.0, 1.2) // 氷のような青白
                      }
                      else -> {
                          weatherState = "Neutral"
                          setColor(1.0, 0.5, 0.8) // デフォルト（マゼンタ系）
                      }
                  }
              }
              
              private fun setColor(r: Double, g: Double, b: Double) {
                  colorR = r; colorG = g; colorB = b
              }

              override fun onLocationChanged(location: Location) {
                  val speedKmh = location.speed * 3.6f
                  // 速度連動: スピードが出ると動きが激しくなる
                  currentSpeedFactor = 0.05f + (speedKmh / 150f).coerceAtMost(0.8f)
              }

              // プラズマ生成ロジック
              private fun startRendering() {
                  isRunning = true
                  renderScope.launch {
                      while (isActive && isRunning) {
                          time += currentSpeedFactor * 0.4

                          for (y in 0 until HEIGHT) {
                              val v = (y.toDouble() / HEIGHT) * 2.0 - 1.0
                              // 高速化のためYループ外で計算できるものはする
                              val cy = cos(v * 4.0 - time)
                              
                              for (x in 0 until WIDTH) {
                                  val u = (x.toDouble() / WIDTH) * 2.0 - 1.0
                                  
                                  // プラズマ計算
                                  var val1 = sin(u * 4.0 + time)
                                  var val2 = cy
                                  var val3 = sin((u + v + time) * 2.0)
                                  var val4 = cos(sqrt(u*u + v*v) * 5.0 - time)
                                  
                                  val f = (val1 + val2 + val3 + val4) / 4.0

                                  // 天気に応じた色適用
                                  val r = ((sin(f * Math.PI) * 127 + 128) * colorR).toInt().coerceIn(0, 255)
                                  val g = ((cos(f * Math.PI) * 127 + 128) * colorG).toInt().coerceIn(0, 255)
                                  val b = ((sin(f * Math.PI + time) * 127 + 128) * colorB).toInt().coerceIn(0, 255)

                                  pixels[y * WIDTH + x] = Color.rgb(r, g, b)
                              }
                          }

                          withContext(Dispatchers.Main) {
                              bitmap.setPixels(pixels, 0, WIDTH, 0, 0, WIDTH, HEIGHT)
                              updateMetadata(bitmap)
                          }
                          delay(33)
                      }
                  }
              }

              private fun updateMetadata(bmp: Bitmap) {
                  // タイトル等は最小限にして、アートを強調
                  val metadata = MediaMetadataCompat.Builder()
                      .putString(MediaMetadataCompat.METADATA_KEY_TITLE, " ") 
                      .putString(MediaMetadataCompat.METADATA_KEY_ARTIST, " ")
                      .putString(MediaMetadataCompat.METADATA_KEY_ALBUM, weatherState) // 天気状態をアルバム名にこっそり表示
                      .putBitmap(MediaMetadataCompat.METADATA_KEY_ALBUM_ART, bmp)
                      .build()
                  mediaSession.setMetadata(metadata)
              }

              override fun onDestroy() {
                  isRunning = false
                  renderScope.cancel()
                  locationManager?.removeUpdates(this)
                  mediaSession.isActive = false
                  mediaSession.release()
                  super.onDestroy()
              }

              // Stub methods
              override fun onStatusChanged(p: String?, s: Int, e: Bundle?) {}
              override fun onProviderEnabled(p: String) {}
              override fun onProviderDisabled(p: String) {}
              override fun onGetRoot(pkg: String, uid: Int, root: Bundle?): BrowserRoot {
                  return BrowserRoot("ROOT", null)
              }
              override fun onLoadChildren(id: String, res: Result<MutableList<MediaBrowserCompat.MediaItem>>) {
                  res.sendResult(mutableListOf())
              }
          }
          EOF

      - name: Build APK
        shell: bash
        run: |
          set -euxo pipefail
          gradle assembleDebug --no-daemon

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: AmbientFlow-Weather-APK
          path: app/build/outputs/apk/debug/app-debug.apk
