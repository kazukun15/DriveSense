name: Build Ambient Flow (Stable)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK packages (API 35 / BuildTools 35)
        shell: bash
        run: |
          set -e
          sdkmanager --install \
            "platform-tools" \
            "platforms;android-35" \
            "build-tools;35.0.0"

      # AGP 8.8.0 の要件: Gradle 8.10.2（互換表に明記）
      - name: Install Gradle 8.10.2
        shell: bash
        run: |
          set -e
          wget -q https://services.gradle.org/distributions/gradle-8.10.2-bin.zip
          unzip -q gradle-8.10.2-bin.zip
          echo "$PWD/gradle-8.10.2/bin" >> $GITHUB_PATH

      - name: Generate Project Files
        shell: bash
        run: |
          set -e

          # --- 1. settings.gradle.kts ---
          cat > settings.gradle.kts <<'EOF'
          pluginManagement {
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
          }
          dependencyResolutionManagement {
              repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
              repositories {
                  google()
                  mavenCentral()
              }
          }
          rootProject.name = "AmbientFlow"
          include(":app")
          EOF

          # --- 2. build.gradle.kts (Project) ---
          # 安定版: AGP 8.8.0 (API 35 正式サポート)
          cat > build.gradle.kts <<'EOF'
          plugins {
              id("com.android.application") version "8.8.0" apply false
              id("org.jetbrains.kotlin.android") version "1.9.24" apply false
          }
          EOF

          # --- 3. gradle.properties ---
          cat > gradle.properties <<'EOF'
          org.gradle.jvmargs=-Xmx4g -XX:+UseParallelGC
          android.useAndroidX=true
          android.enableJetifier=true
          kotlin.code.style=official
          android.nonTransitiveRClass=true
          EOF

          # --- 4. App structure ---
          mkdir -p app/src/main/java/jp/kazukun/ambient
          mkdir -p app/src/main/res/xml
          mkdir -p app/src/main/res/values
          mkdir -p app/src/main/res/drawable
          mkdir -p app/src/main/res/mipmap-anydpi-v26

          # --- 5. app/build.gradle.kts ---
          cat > app/build.gradle.kts <<'EOF'
          plugins {
              id("com.android.application")
              id("org.jetbrains.kotlin.android")
          }

          android {
              namespace = "jp.kazukun.ambient"
              compileSdk = 35

              defaultConfig {
                  applicationId = "jp.kazukun.ambient"
                  minSdk = 26
                  targetSdk = 35
                  versionCode = 20
                  versionName = "8.0.Resurrection"
              }

              buildTypes {
                  release { isMinifyEnabled = false }
              }

              compileOptions {
                  sourceCompatibility = JavaVersion.VERSION_17
                  targetCompatibility = JavaVersion.VERSION_17
              }
              kotlinOptions { jvmTarget = "17" }
          }

          dependencies {
              implementation("androidx.core:core-ktx:1.12.0")
              implementation("androidx.appcompat:appcompat:1.6.1")
              implementation("androidx.media:media:1.7.0")
              implementation("com.google.android.gms:play-services-location:21.0.1")
              implementation("org.jetbrains.kotlinx:kotlinx-coroutines-android:1.7.3")
          }
          EOF

          # --- 6. resources ---
          cat > app/src/main/res/values/strings.xml <<'EOF'
          <resources>
              <string name="app_name">Ambient Flow</string>
              <string name="status_channel">Ambient Status</string>
          </resources>
          EOF

          cat > app/src/main/res/xml/automotive_app_desc.xml <<'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <automotiveApp xmlns:android="http://schemas.android.com/apk/res/android">
              <uses name="media" />
          </automotiveApp>
          EOF

          cat > app/src/main/res/drawable/ic_launcher_background.xml <<'EOF'
          <vector xmlns:android="http://schemas.android.com/apk/res/android"
              android:width="108dp" android:height="108dp"
              android:viewportWidth="108" android:viewportHeight="108">
              <path android:fillColor="#000000" android:pathData="M0,0h108v108h-108z"/>
          </vector>
          EOF

          cat > app/src/main/res/drawable/ic_launcher_foreground.xml <<'EOF'
          <vector xmlns:android="http://schemas.android.com/apk/res/android"
              android:width="108dp" android:height="108dp"
              android:viewportWidth="108" android:viewportHeight="108">
              <path android:fillColor="#FFFFFF"
                  android:pathData="M54,26 A28,28 0 1,0 54,82 A28,28 0 1,0 54,26
                                   M54,40 A14,14 0 1,1 54,68 A14,14 0 1,1 54,40"/>
          </vector>
          EOF

          cat > app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml <<'EOF'
          <adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
              <background android:drawable="@drawable/ic_launcher_background"/>
              <foreground android:drawable="@drawable/ic_launcher_foreground"/>
          </adaptive-icon>
          EOF
          cp app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml app/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml

          # --- 7. AndroidManifest.xml ---
          # package="..." は AGP 8 系では namespace として無視されるので付けない
          cat > app/src/main/AndroidManifest.xml <<'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">

              <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE_MEDIA_PLAYBACK" />
              <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
              <uses-permission android:name="android.permission.INTERNET" />
              <uses-permission android:name="android.permission.WAKE_LOCK" />

              <application
                  android:label="Ambient Flow"
                  android:icon="@mipmap/ic_launcher"
                  android:theme="@style/Theme.AppCompat.NoActionBar">

                  <meta-data
                      android:name="com.google.android.gms.car.application"
                      android:resource="@xml/automotive_app_desc" />

                  <service
                      android:name=".AmbientMediaService"
                      android:exported="true"
                      android:foregroundServiceType="mediaPlayback">
                      <intent-filter>
                          <action android:name="android.media.browse.MediaBrowserService" />
                      </intent-filter>
                  </service>

                  <activity
                      android:name=".MainActivity"
                      android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>

              </application>
          </manifest>
          EOF

          # --- 8. MainActivity.kt ---
          cat > app/src/main/java/jp/kazukun/ambient/MainActivity.kt <<'EOF'
          package jp.kazukun.ambient

          import android.Manifest
          import android.content.Intent
          import android.content.pm.PackageManager
          import android.os.Build
          import android.os.Bundle
          import androidx.appcompat.app.AppCompatActivity
          import androidx.core.app.ActivityCompat
          import androidx.core.content.ContextCompat

          class MainActivity : AppCompatActivity() {
              override fun onCreate(savedInstanceState: Bundle?) {
                  super.onCreate(savedInstanceState)

                  startServiceSafe()

                  if (Build.VERSION.SDK_INT >= 33) {
                      if (ContextCompat.checkSelfPermission(
                              this,
                              Manifest.permission.POST_NOTIFICATIONS
                          ) != PackageManager.PERMISSION_GRANTED
                      ) {
                          ActivityCompat.requestPermissions(
                              this,
                              arrayOf(Manifest.permission.POST_NOTIFICATIONS),
                              99
                          )
                      }
                  }
              }

              private fun startServiceSafe() {
                  try {
                      val intent = Intent(this, AmbientMediaService::class.java)
                      ContextCompat.startForegroundService(this, intent)
                  } catch (e: Exception) {
                      e.printStackTrace()
                  }
              }
          }
          EOF

          # --- 9. AmbientMediaService.kt (FIX: isActive compile error) ---
          cat > app/src/main/java/jp/kazukun/ambient/AmbientMediaService.kt <<'EOF'
          package jp.kazukun.ambient

          import android.app.Notification
          import android.app.NotificationChannel
          import android.app.NotificationManager
          import android.content.Context
          import android.content.Intent
          import android.content.pm.ServiceInfo
          import android.graphics.Bitmap
          import android.graphics.Canvas
          import android.graphics.Color
          import android.graphics.LinearGradient
          import android.graphics.Paint
          import android.graphics.Shader
          import android.os.Build
          import android.os.Bundle
          import android.support.v4.media.MediaBrowserCompat
          import android.support.v4.media.MediaDescriptionCompat
          import android.support.v4.media.MediaMetadataCompat
          import android.support.v4.media.session.MediaSessionCompat
          import android.support.v4.media.session.PlaybackStateCompat
          import androidx.core.app.NotificationCompat
          import androidx.media.MediaBrowserServiceCompat
          import androidx.media.app.NotificationCompat.MediaStyle
          import kotlinx.coroutines.CoroutineScope
          import kotlinx.coroutines.Dispatchers
          import kotlinx.coroutines.Job
          import kotlinx.coroutines.cancel
          import kotlinx.coroutines.launch

          class AmbientMediaService : MediaBrowserServiceCompat() {

              private lateinit var mediaSession: MediaSessionCompat
              private val scope = CoroutineScope(Dispatchers.Default + Job())

              private val BITMAP_SIZE = 1024
              private val bitmap = Bitmap.createBitmap(BITMAP_SIZE, BITMAP_SIZE, Bitmap.Config.ARGB_8888)
              private val canvas = Canvas(bitmap)
              private val paint = Paint()

              private val CHANNEL_ID = "ambient_status_channel"
              private val NOTIFICATION_ID = 777

              override fun onCreate() {
                  super.onCreate()
                  createNotificationChannel()

                  mediaSession = MediaSessionCompat(this, "AmbientSession").apply {
                      isActive = true
                  }
                  sessionToken = mediaSession.sessionToken

                  mediaSession.setCallback(object : MediaSessionCompat.Callback() {
                      override fun onPlay() {
                          setPlaybackState(PlaybackStateCompat.STATE_PLAYING)
                          updateDisplay("Active")
                      }

                      override fun onPrepare() {
                          // FIX: isActive は CoroutineScope/CoroutineContext の拡張で、
                          // Callback 内の isActive = true はコンパイル不可。
                          mediaSession.isActive = true
                          updateDisplay("Prepared")
                      }

                      override fun onStop() {
                          stopSelf()
                      }
                  })

                  setPlaybackState(PlaybackStateCompat.STATE_PLAYING)
                  updateDisplay("READY")
              }

              override fun onStartCommand(intent: Intent?, flags: Int, startId: Int): Int {
                  try {
                      val notif = buildNotification("Running")
                      if (Build.VERSION.SDK_INT >= 29) {
                          startForeground(
                              NOTIFICATION_ID,
                              notif,
                              ServiceInfo.FOREGROUND_SERVICE_TYPE_MEDIA_PLAYBACK
                          )
                      } else {
                          startForeground(NOTIFICATION_ID, notif)
                      }
                  } catch (_: Exception) { }

                  updateDisplay("Ambient Mode")
                  return START_STICKY
              }

              override fun onDestroy() {
                  try { mediaSession.release() } catch (_: Exception) { }
                  scope.cancel()
                  super.onDestroy()
              }

              override fun onGetRoot(clientPackageName: String, clientUid: Int, rootHints: Bundle?): BrowserRoot {
                  return BrowserRoot("ROOT", null)
              }

              override fun onLoadChildren(parentId: String, result: Result<MutableList<MediaBrowserCompat.MediaItem>>) {
                  val items = mutableListOf<MediaBrowserCompat.MediaItem>()
                  val desc = MediaDescriptionCompat.Builder()
                      .setMediaId("ambient_main")
                      .setTitle("Ambient Flow")
                      .setSubtitle("Peugeot Mode")
                      .build()
                  items.add(MediaBrowserCompat.MediaItem(desc, MediaBrowserCompat.MediaItem.FLAG_PLAYABLE))
                  result.sendResult(items)
              }

              private fun updateDisplay(text: String) {
                  scope.launch {
                      paint.shader = LinearGradient(
                          0f, 0f, 0f, BITMAP_SIZE.toFloat(),
                          Color.parseColor("#050510"),
                          Color.parseColor("#1A237E"),
                          Shader.TileMode.CLAMP
                      )
                      canvas.drawRect(0f, 0f, BITMAP_SIZE.toFloat(), BITMAP_SIZE.toFloat(), paint)

                      val textP = Paint().apply {
                          color = Color.WHITE
                          textSize = 100f
                          textAlign = Paint.Align.CENTER
                          isAntiAlias = true
                      }
                      canvas.drawText(text, (BITMAP_SIZE / 2).toFloat(), (BITMAP_SIZE / 2).toFloat(), textP)

                      val metadata = MediaMetadataCompat.Builder()
                          .putString(MediaMetadataCompat.METADATA_KEY_TITLE, text)
                          .putString(MediaMetadataCompat.METADATA_KEY_ARTIST, "Ambient Flow")
                          .putBitmap(MediaMetadataCompat.METADATA_KEY_ALBUM_ART, bitmap)
                          .putBitmap(MediaMetadataCompat.METADATA_KEY_DISPLAY_ICON, bitmap)
                          .build()

                      mediaSession.setMetadata(metadata)
                  }
              }

              private fun setPlaybackState(state: Int) {
                  val st = PlaybackStateCompat.Builder()
                      .setActions(PlaybackStateCompat.ACTION_PLAY or PlaybackStateCompat.ACTION_PAUSE)
                      .setState(state, 0L, 1.0f)
                      .build()
                  mediaSession.setPlaybackState(st)
              }

              private fun buildNotification(text: String): Notification {
                  return NotificationCompat.Builder(this, CHANNEL_ID)
                      .setContentTitle("Ambient Flow")
                      .setContentText(text)
                      .setSmallIcon(R.drawable.ic_launcher_foreground)
                      .setVisibility(NotificationCompat.VISIBILITY_PUBLIC)
                      .setStyle(MediaStyle().setMediaSession(mediaSession.sessionToken))
                      .setOngoing(true)
                      .build()
              }

              private fun createNotificationChannel() {
                  if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                      val ch = NotificationChannel(CHANNEL_ID, "Ambient Status", NotificationManager.IMPORTANCE_LOW)
                      val mgr = getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager
                      mgr.createNotificationChannel(ch)
                  }
              }
          }
          EOF

      - name: Build APK
        shell: bash
        run: |
          set -e
          gradle assembleDebug --no-daemon

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: AmbientFlow-Stable-APK
          path: app/build/outputs/apk/debug/app-debug.apk
