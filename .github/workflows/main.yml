name: Build Android Auto Visualizer

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # Gradle 8.6 „Çí‰ΩøÁî®ÔºàÂÆâÂÆöÁâàÔºâ
      - name: Install Gradle 8.6
        shell: bash
        run: |
          set -euxo pipefail
          wget -q https://services.gradle.org/distributions/gradle-8.6-bin.zip
          unzip -q gradle-8.6-bin.zip
          echo "$PWD/gradle-8.6/bin" >> $GITHUB_PATH

      - name: Generate Project Files
        shell: bash
        run: |
          set -euxo pipefail

          PKG="com.example.drivesense"
          APP_LABEL="Drive Visualizer"

          # 1. settings.gradle.kts
          cat > settings.gradle.kts <<EOF
          pluginManagement {
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
          }
          dependencyResolutionManagement {
              repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
              repositories {
                  google()
                  mavenCentral()
              }
          }
          rootProject.name = "DriveSense"
          include(":app")
          EOF

          # 2. build.gradle.kts (Project)
          cat > build.gradle.kts <<EOF
          plugins {
              id("com.android.application") version "8.3.0" apply false
              id("org.jetbrains.kotlin.android") version "1.9.23" apply false
          }
          EOF

          # 3. gradle.properties
          cat > gradle.properties <<EOF
          org.gradle.jvmargs=-Xmx2g
          android.useAndroidX=true
          android.enableJetifier=true
          kotlin.code.style=official
          EOF

          # 4. App Module
          mkdir -p app/src/main/{java/com/example/drivesense,res/xml,res/values,res/drawable,res/mipmap-anydpi-v26}

          cat > app/build.gradle.kts <<EOF
          plugins {
              id("com.android.application")
              id("org.jetbrains.kotlin.android")
          }

          android {
              namespace = "$PKG"
              compileSdk = 34

              defaultConfig {
                  applicationId = "$PKG"
                  minSdk = 24  // „Éì„ÉÉ„Éà„Éû„ÉÉ„ÉóÁîüÊàê„ÅÆ„Åü„ÇÅÂ∞ë„Åó‰∏ä„Åí„Åæ„Åô
                  targetSdk = 34
                  versionCode = 1
                  versionName = "2.0"
              }
              buildTypes {
                  release { isMinifyEnabled = false }
              }
              compileOptions {
                  sourceCompatibility = JavaVersion.VERSION_17
                  targetCompatibility = JavaVersion.VERSION_17
              }
              kotlinOptions { jvmTarget = "17" }
          }

          dependencies {
              implementation("androidx.core:core-ktx:1.12.0")
              implementation("androidx.appcompat:appcompat:1.6.1")
              implementation("androidx.media:media:1.7.0")
              // GPSÁî®
              implementation("com.google.android.gms:play-services-location:21.0.1")
          }
          EOF

          # --- Resources ---
          cat > app/src/main/res/values/strings.xml <<EOF
          <resources>
              <string name="app_name">$APP_LABEL</string>
          </resources>
          EOF

          cat > app/src/main/res/xml/automotive_app_desc.xml <<EOF
          <?xml version="1.0" encoding="utf-8"?>
          <automotiveApp xmlns:android="http://schemas.android.com/apk/res/android">
              <uses name="media" />
          </automotiveApp>
          EOF

          # Icons (Dummy)
          cat > app/src/main/res/drawable/ic_launcher_background.xml <<EOF
          <vector xmlns:android="http://schemas.android.com/apk/res/android"
              android:width="108dp" android:height="108dp"
              android:viewportWidth="108" android:viewportHeight="108">
              <path android:fillColor="#000000" android:pathData="M0,0h108v108h-108z"/>
          </vector>
          EOF
          cat > app/src/main/res/drawable/ic_launcher_foreground.xml <<EOF
          <vector xmlns:android="http://schemas.android.com/apk/res/android"
              android:width="108dp" android:height="108dp"
              android:viewportWidth="108" android:viewportHeight="108">
              <path android:fillColor="#00FF00" android:pathData="M54,26 A28,28 0 1,0 54,82 A28,28 0 1,0 54,26"/>
          </vector>
          EOF
          cat > app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml <<EOF
          <adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android">
              <background android:drawable="@drawable/ic_launcher_background"/>
              <foreground android:drawable="@drawable/ic_launcher_foreground"/>
          </adaptive-icon>
          EOF
          cp app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml app/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml

          # Manifest (GPSÊ®©Èôê„ÇíËøΩÂä†)
          cat > app/src/main/AndroidManifest.xml <<EOF
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android" package="$PKG">
              
              <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
              <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE_LOCATION" />

              <application
                  android:label="$APP_LABEL"
                  android:allowBackup="true"
                  android:supportsRtl="true"
                  android:icon="@mipmap/ic_launcher"
                  android:roundIcon="@mipmap/ic_launcher_round"
                  android:theme="@style/Theme.AppCompat.Light.NoActionBar">

                  <meta-data
                      android:name="com.google.android.gms.car.application"
                      android:resource="@xml/automotive_app_desc" />

                  <service
                      android:name=".DriveSenseMediaService"
                      android:exported="true"
                      android:foregroundServiceType="location">
                      <intent-filter>
                          <action android:name="android.media.browse.MediaBrowserService" />
                      </intent-filter>
                  </service>

                  <activity
                      android:name=".MainActivity"
                      android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF

          # --- Kotlin Code („Åì„Åì„ÅåÈù©Êñ∞Ê©üËÉΩ„ÅÆÂøÉËáìÈÉ®) ---
          
          # 1. MainActivity (Ê®©Èôê„É™„ÇØ„Ç®„Çπ„ÉàÁî®)
          cat > app/src/main/java/com/example/drivesense/MainActivity.kt <<EOF
          package $PKG
          import android.Manifest
          import android.os.Bundle
          import androidx.appcompat.app.AppCompatActivity
          import androidx.core.app.ActivityCompat

          class MainActivity : AppCompatActivity() {
              override fun onCreate(savedInstanceState: Bundle?) {
                  super.onCreate(savedInstanceState)
                  // „Ç¢„Éó„É™Ëµ∑ÂãïÊôÇ„Å´‰ΩçÁΩÆÊÉÖÂ†±Ê®©Èôê„ÇíÊ±Ç„ÇÅ„Çã
                  ActivityCompat.requestPermissions(
                      this,
                      arrayOf(Manifest.permission.ACCESS_FINE_LOCATION),
                      1
                  )
              }
          }
          EOF

          # 2. DriveSenseMediaService („Éì„Ç∏„É•„Ç¢„É©„Ç§„Ç∂„ÉºÊú¨‰Ωì)
          cat > app/src/main/java/com/example/drivesense/DriveSenseMediaService.kt <<EOF
          package $PKG

          import android.Manifest
          import android.annotation.SuppressLint
          import android.content.Context
          import android.content.pm.PackageManager
          import android.graphics.Bitmap
          import android.graphics.Canvas
          import android.graphics.Color
          import android.graphics.Paint
          import android.location.Location
          import android.location.LocationListener
          import android.location.LocationManager
          import android.os.Bundle
          import android.os.Handler
          import android.os.Looper
          import androidx.core.content.ContextCompat
          import androidx.media.MediaBrowserServiceCompat
          import android.support.v4.media.MediaBrowserCompat
          import android.support.v4.media.MediaMetadataCompat
          import android.support.v4.media.session.MediaSessionCompat
          import android.support.v4.media.session.PlaybackStateCompat
          import java.util.Calendar

          class DriveSenseMediaService : MediaBrowserServiceCompat(), LocationListener {
              private lateinit var mediaSession: MediaSessionCompat
              private var locationManager: LocationManager? = null
              private val handler = Handler(Looper.getMainLooper())
              private var currentSpeedKmH = 0f
              
              // „Éì„Ç∏„É•„Ç¢„É©„Ç§„Ç∂„ÉºÊõ¥Êñ∞Áî®„É´„Éº„Éó
              private val updateRunnable = object : Runnable {
                  override fun run() {
                      updateVisualizer()
                      handler.postDelayed(this, 1000) // 1Áßí„Åî„Å®„Å´Êõ¥Êñ∞
                  }
              }

              override fun onCreate() {
                  super.onCreate()
                  
                  // „É°„Éá„Ç£„Ç¢„Çª„ÉÉ„Ç∑„Éß„É≥ÂàùÊúüÂåñ
                  mediaSession = MediaSessionCompat(this, "DriveSenseSession").apply {
                      setCallback(object : MediaSessionCompat.Callback() {})
                      isActive = true
                      
                      // ÂÜçÁîü‰∏≠Áä∂ÊÖã„Å´„Åô„Çã
                      setPlaybackState(PlaybackStateCompat.Builder()
                          .setActions(PlaybackStateCompat.ACTION_PLAY or PlaybackStateCompat.ACTION_PAUSE)
                          .setState(PlaybackStateCompat.STATE_PLAYING, 0L, 1.0f)
                          .build())
                  }
                  sessionToken = mediaSession.sessionToken

                  // GPS„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
                  setupLocation()
                  
                  // „Éì„Ç∏„É•„Ç¢„É©„Ç§„Ç∂„ÉºÈñãÂßã
                  handler.post(updateRunnable)
              }

              private fun setupLocation() {
                  if (ContextCompat.checkSelfPermission(this, Manifest.permission.ACCESS_FINE_LOCATION) == PackageManager.PERMISSION_GRANTED) {
                      locationManager = getSystemService(Context.LOCATION_SERVICE) as LocationManager
                      try {
                          locationManager?.requestLocationUpdates(LocationManager.GPS_PROVIDER, 1000, 1f, this)
                      } catch (e: Exception) { e.printStackTrace() }
                  }
              }

              // ‰ΩçÁΩÆÊÉÖÂ†±Êõ¥Êñ∞ÊôÇ
              override fun onLocationChanged(location: Location) {
                  // m/s „Çí km/h „Å´Â§âÊèõ
                  currentSpeedKmH = location.speed * 3.6f
                  updateVisualizer()
              }

              // „Éì„Ç∏„É•„Ç¢„É©„Ç§„Ç∂„ÉºÊèèÁîª„É≠„Ç∏„ÉÉ„ÇØÔºà„Åì„Åì„Åå„ÄåÂãïÁöÑ„Ç¢„É´„Éê„É†„Ç¢„Éº„Éà„Äç„ÅÆËÇùÔºâ
              private fun updateVisualizer() {
                  val speed = currentSpeedKmH.toInt()
                  
                  // 1. „É°„Çø„Éá„Éº„ÇøÔºàÊñáÂ≠óÊÉÖÂ†±Ôºâ„ÅÆ‰ΩúÊàê
                  val hour = Calendar.getInstance().get(Calendar.HOUR_OF_DAY)
                  val weatherIcon = if (hour in 6..18) "‚òÄ" else "üåô" // Á∞°ÊòìÁöÑ„Å™ÊòºÂ§úÂà§ÂÆö
                  val titleText = "Velocity: \$speed km/h"
                  val subText = "Env: \$weatherIcon | Visualizer Active"

                  // 2. Âπæ‰ΩïÂ≠¶Ê®°ÊßòÔºàBitmapÔºâ„ÅÆÁîüÊàê
                  val artBitmap = generateGeometricArt(speed)

                  // 3. Android Auto„Å´ÈÄÅ‰ø°
                  val metadata = MediaMetadataCompat.Builder()
                      .putString(MediaMetadataCompat.METADATA_KEY_TITLE, titleText)
                      .putString(MediaMetadataCompat.METADATA_KEY_DISPLAY_TITLE, titleText)
                      .putString(MediaMetadataCompat.METADATA_KEY_ARTIST, subText)
                      .putString(MediaMetadataCompat.METADATA_KEY_ALBUM, "Drive Sense OS")
                      .putBitmap(MediaMetadataCompat.METADATA_KEY_ALBUM_ART, artBitmap) // „Åì„Åì„ÅßÁîªÂÉè„ÇíÈÄÅ„Çã
                      .build()
                      
                  mediaSession.setMetadata(metadata)
              }

              // ÈÄüÂ∫¶„Å´Âøú„Åò„Å¶Â§âÂåñ„Åô„ÇãÁîªÂÉè„Çí„Éó„É≠„Ç∞„É©„É†„ÅßÊèè„Åè
              private fun generateGeometricArt(speed: Int): Bitmap {
                  val size = 512
                  val bitmap = Bitmap.createBitmap(size, size, Bitmap.Config.ARGB_8888)
                  val canvas = Canvas(bitmap)
                  val paint = Paint().apply { isAntiAlias = true }

                  // ËÉåÊôØËâ≤ÔºàÈÄüÂ∫¶„Åå‰∏ä„Åå„Çã„Å®Â∞ë„ÅóËµ§„Åø„Åå„Åã„ÇãÔºâ
                  val redBg = (speed * 2).coerceIn(0, 50)
                  canvas.drawColor(Color.rgb(10 + redBg, 10, 20))

                  // ‰∏≠ÂøÉÂ∫ßÊ®ô
                  val cx = size / 2f
                  val cy = size / 2f

                  // ÂÜÜ„ÅÆÊèèÁîªÔºàÈÄüÂ∫¶„Å´Âøú„Åò„Å¶Â§ß„Åç„Åè„Å™„ÇãÔºâ
                  val baseRadius = 100f
                  val speedFactor = (speed * 2f).coerceIn(0f, 200f)
                  
                  // Â§ñÂÅ¥„ÅÆ„Ç∞„É≠„ÉºÂäπÊûú
                  paint.style = Paint.Style.STROKE
                  paint.strokeWidth = 5f
                  paint.color = if (speed > 50) Color.RED else Color.CYAN
                  paint.alpha = 100
                  canvas.drawCircle(cx, cy, baseRadius + speedFactor + 20, paint)

                  // „É°„Ç§„É≥„ÅÆÂÜÜ
                  paint.style = Paint.Style.FILL
                  paint.color = if (speed > 80) Color.MAGENTA else if (speed > 40) Color.YELLOW else Color.BLUE
                  paint.alpha = 200
                  canvas.drawCircle(cx, cy, baseRadius + speedFactor, paint)

                  // Âπæ‰ΩïÂ≠¶ÁöÑ„Å™„É©„Ç§„É≥
                  paint.color = Color.WHITE
                  paint.strokeWidth = 3f
                  paint.style = Paint.Style.STROKE
                  canvas.drawLine(0f, cy, size.toFloat(), cy, paint)
                  canvas.drawLine(cx, 0f, cx, size.toFloat(), paint)
                  
                  // ÈÄüÂ∫¶„ÅÆÂÜÜÁí∞
                  paint.style = Paint.Style.STROKE
                  paint.strokeWidth = 10f
                  canvas.drawArc(50f, 50f, size-50f, size-50f, 135f, speed.toFloat() * 2, false, paint)

                  return bitmap
              }

              override fun onDestroy() {
                  handler.removeCallbacks(updateRunnable)
                  locationManager?.removeUpdates(this)
                  mediaSession.isActive = false
                  mediaSession.release()
                  super.onDestroy()
              }

              // „Åù„ÅÆ‰ªñ„ÅÆLocationListenerÂøÖÈ†à„É°„ÇΩ„ÉÉ„Éâ
              override fun onStatusChanged(provider: String?, status: Int, extras: Bundle?) {}
              override fun onProviderEnabled(provider: String) {}
              override fun onProviderDisabled(provider: String) {}
              
              override fun onGetRoot(clientPackageName: String, clientUid: Int, rootHints: Bundle?): BrowserRoot {
                  return BrowserRoot("ROOT", null)
              }
              override fun onLoadChildren(parentId: String, result: Result<MutableList<MediaBrowserCompat.MediaItem>>) {
                  result.sendResult(mutableListOf())
              }
          }
          EOF

      - name: Build APK
        shell: bash
        run: |
          set -euxo pipefail
          gradle assembleDebug --no-daemon

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: DriveSense-Visualizer-APK
          path: app/build/outputs/apk/debug/app-debug.apk
