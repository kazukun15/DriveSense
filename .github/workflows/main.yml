package jp.kazukun.peugeot.final

import android.location.Location
import android.location.LocationListener
import android.location.LocationManager
import android.os.Bundle
import androidx.car.app.Screen
import androidx.car.app.model.*

class CockpitScreen : Screen, LocationListener {

    private var speedKmh = 0

    override fun onGetTemplate(): Template {
        val speedText = "${speedKmh} km/h"

        return PaneTemplate.Builder(
            Pane.Builder()
                .addRow(
                    Row.Builder()
                        .setTitle("i-Cockpit")
                        .addText("現在速度: $speedText")
                        .build()
                )
                .build()
        )
            .setTitle("Peugeot Final")
            .build()
    }

    override fun onLocationChanged(location: Location) {
        speedKmh = (location.speed * 3.6f).toInt()
        invalidate()
    }

    override fun onAttached() {
        super.onAttached()
        val lm = carContext.getSystemService(LocationManager::class.java)
        try {
            lm.requestLocationUpdates(LocationManager.GPS_PROVIDER, 1000, 0f, this)
        } catch (e: Exception) {
            e.printStackTrace()
        }
    }

    override fun onDetached() {
        super.onDetached()
        val lm = carContext.getSystemService(LocationManager::class.java)
        lm.removeUpdates(this)
    }
}
